# Convex (web) Setup & Architecture — YouPreacher

This guide describes the current Convex installation and how to reproduce it for the web front-end so it can run against the same architecture and access patterns as the mobile app. It focuses on the concrete settings, environment variables, auth setup, and the code patterns that must be followed for the web client to work with Convex and Clerk.

---

## Summary (what you need)
- Convex project with the schema & server functions in `convex/`
- Clerk application with a JWT Template named `convex` (Issuer URL + applicationID must match Convex auth config)
- Environment variables:
  - `EXPO_PUBLIC_CONVEX_URL` (or `NEXT_PUBLIC_CONVEX_URL` for web apps)
  - `EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY` (publishable frontend key for Clerk)
  - CLERK JWT/ISSUER/APP info (configure in Convex auth and `convex.config.js`)
- CLI tooling: `npm install`, `npx convex dev`, `npx convex deploy`

---

## What You’ll Find in This Repo
- `convex/schema.ts` — Convex schema (series, sermons, profiles, community, and bible_cache)
- `convex/` — server functions & LLM helpers used by the app (prompts and functions)
- `convex/auth.config.ts` and `convex.config.js` — Convex auth settings (Clerk issuer & applicationID)
- `convex/_generated/` — generated types & api (run `npx convex dev` to refresh)
- `services/convexClient.ts` — React Convex client integration and auth setup (mobile example)
- `services/sync/*` — sync flow and SQLite mapping logic used by mobile (local-first pattern)

---

## High-Level Architecture & Patterns
1. Local-first data flow (mobile): writes persist to local SQLite then sync to Convex.
   - SQLite tables live in `services/db/sqlite.native.ts` and use `convex_id_mapping` to map local -> remote IDs
   - `services/sync/convexSyncHandler.ts` orchestrates push/pull, creates mappings, and applies timestamp-based `newest_wins` conflict resolution

2. Convex functions depend on authenticated user identity via Clerk JWT:
   - Server functions call `ctx.auth.getUserIdentity()` and will throw if the request is unauthenticated
   - Web and mobile clients must set the Convex client `setAuth` to return a Clerk JWT token for the `convex` JWT template

3. Generated TypeScript types (`convex/_generated/api`) are required for type-safe function references and client code. Regenerate by running `npx convex dev`.

---

## Environment & Convex Configuration
1. Convex config is in `convex.config.js`.
   - Set `schema`, `functions`, and `auth`.
   - Ensure `auth.domain` matches your Clerk issuer (e.g., `https://your-app.clerk.accounts.dev`) and `auth.applicationID` is `convex` (or adjust accordingly).

2. Example `convex/auth.config.ts` produced in this project:
```ts
export default {
  providers: [
    {
      domain: "https://wired-prawn-63.clerk.accounts.dev",
      applicationID: "convex",
    },
  ],
};
```

3. Update environment variables for the web app. Use whatever prefix your web build uses (`NEXT_PUBLIC_...`) if necessary. Example:
```bash
# For development
NEXT_PUBLIC_CONVEX_URL=https://colorful-ox-168.convex.cloud
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_your_key_here

# For mobile we use EXPO_* env names; the web build can use NEXT_PUBLIC_* or other env conventions
```

---

## Clerk Setup (JWT template)
Convex requires a Clerk JWT that has an issuer set to match your `convex/auth.config.ts`. Follow these steps in the Clerk dashboard:
1. Log into Clerk and choose your application
2. Create a JWT template and name it `convex` (matching `applicationID` in Convex config)
3. Add any required claims you wish to validate in Convex functions
4. Ensure `issuer` value matches `convex/auth.config.ts` `domain` (e.g., `https://your-app.clerk.accounts.dev`)

This ensures that the JWT generated by Clerk is accepted by Convex auth and authorizes `ctx.auth.getUserIdentity()`.

---

## Setting up Convex for Web Development
Follow these steps to get a web dev environment working that matches the app architecture:

1. Install dependencies
```bash
npm install
# Add convex and Clerk dependencies if not present
npm install convex @clerk/clerk-react
```

2. Configure environment variables in `.env.local` or CI
```bash
NEXT_PUBLIC_CONVEX_URL=https://colorful-ox-168.convex.cloud
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_your_key_here
NEXT_PUBLIC_CLERK_ISSUER=https://your-app.clerk.accounts.dev
```

3. Update `convex/config` (if needed)
- Make sure `convex.config.js` points at `convex/schema.ts` and `convex/**`
- Set `auth.domain` to your Clerk issuer and `auth.applicationID` to the JWT template name (default: `convex`)

4. Run Convex dev server locally
```bash
npx convex dev
```
- This pushes schema changes to your Convex development instance
- Generates `convex/_generated/api` TypeScript types

5. Start your web app (example using Next.js or CRA)
```bash
npm run dev
# or
next dev
```

6. Verify the client can reach Convex
- Open the browser console and ensure the application can read `NEXT_PUBLIC_CONVEX_URL`
- If your functions throw `Not authenticated`, see the Clerk auth steps below

---

## Web Convex Client Example (Next.js or React)
This example shows how to create a typed Convex client and set the Convex auth token from Clerk (using @clerk/clerk-react). The mobile app uses `getToken({ template: 'convex' })` to fetch tokens; the web should do the same.

Example using `@clerk/clerk-react` and Convex:
```tsx
// src/services/convexClient.web.ts
import { ConvexReactClient } from 'convex/react';
import { useAuth } from '@clerk/clerk-react';

const convexUrl = process.env.NEXT_PUBLIC_CONVEX_URL || '';
export const convexClient = new ConvexReactClient(convexUrl);
export const convex = convexClient;

export function useConvexClerkAuth() {
  const { getToken } = useAuth();

  useEffect(() => {
    convexClient.setAuth(async () => {
      try {
        const token = await getToken({ template: 'convex' });
        return token;
      } catch (err) {
        console.error('Failed to get Clerk token for Convex:', err);
        return null;
      }
    });
  }, [getToken]);
}
```

Notes:
- `getToken({ template: 'convex' })` must use the exact JWT template name you created in Clerk.
- On web you may want to persist the token or check refresh flows for Clerk SDKs.

---

## Code Patterns & Integration Points
- Use the typed API generated in `convex/_generated/api` for server function calls (e.g., `convexClient.query(api.sermons.list, {})`)
- Server functions enforce authentication using `ctx.auth.getUserIdentity()` and will reject unauthenticated requests
- Convex functions that call external APIs (LLM helpers in `convex/functions/*`) should follow existing prompt patterns in `convex/prompts/*` and use `convex/bibleCache.ts` for caching
- If the web app follows the local-first approach, replicate mapping & sync tables similar to mobile (SQLite is mobile-specific). For web, consider using local storage or IndexedDB if offline support is required.

---

## If You Need Local-First on Web
This repository uses local-first persistence for the mobile app (SQLite) before syncing to Convex. For web apps who want to support the same model:
- Use IndexedDB (via Dexter/Idb or localforage) as a local store
- Implement a `convex_id_mapping` equivalent to map local IDs to Convex IDs
- Reuse the push/pull logic from `services/sync/convexSyncHandler.ts` as a starting point (mirror it to web code)

Implementation notes:
- Keep `updatedAt`/`createdAt` timestamps to support `newest_wins` conflict resolution
- Use the `dirty` flag or a replication queue for local writes
- Avoid bypassing repository helpers: implement repository layer functions to read/write local data and mark entries for sync

---

## Deploying Convex Functions
To deploy to a Convex instance:
```bash
# Build or push your functions/schema
npx convex deploy
```
- This publishes your server functions & schema to the target Convex deployment

## Testing Auth & Convex Access
1. Ensure your Clerk app is configured and JWT template created
2. In web app, sign in to Clerk
3. Verify `getToken({ template: 'convex' })` returns a valid JWT
4. Confirm the web client `convexClient` uses that token via `setAuth`
5. Call a protected Convex function (e.g., `api.sermons.list`) and confirm the request returns data for the signed-in user

---

## Troubleshooting
- "Not authenticated": Ensure the Clerk JWT template exists and the domain + app name match `convex/config` and `convex/auth.config.ts`.
- "Type errors" after schema changes: run `npx convex dev` to regenerate `convex/_generated/api` types.
- Convex URL mismatch: ensure `NEXT_PUBLIC_CONVEX_URL` (or `EXPO_PUBLIC_CONVEX_URL`) is set to the correct deployment. For local dev `npx convex dev` exposes a dev URL.
- Missing functions: make sure `convex.config.js` includes `functions: "./convex/**"` and that `npx convex dev` or `npx convex deploy` is run.

---

## Files to Review & Follow
- `convex/schema.ts` (data model)
- `convex/sermons.ts`, `convex/series.ts`, `convex/profiles.ts`, `convex/community.ts` (server functions)
- `convex/functions/*` & `prompts/*` (LLM & helper functions)
- `convex/bibleCache.ts` (prompt caching pattern)
- `services/convexClient.ts` (mobile example client)
- `convex.config.js` & `convex/auth.config.ts` (auth settings)
- `services/sync/convexSyncHandler.ts` (push/pull sync logic)

---

If you'd like, I can also:
- Create a small web sample app folder `web-convex-example/` with a `Next.js` setup that demonstrates the Convex setup + Clerk auth + sample query/mutation
- Or run a quick grep for direct Convex writes from UI files to ensure all writes go through repository logic

Please tell me which you'd prefer next.
