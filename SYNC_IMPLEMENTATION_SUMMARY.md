# Clerk Auth + Convex Sync Implementation Summary

## Implementation Status

### ✅ Completed

1. **Created unified sync handler service** (`services/sync/convexSyncHandler.ts`)
   - Checks Clerk authentication status
   - Performs bidirectional sync with Convex
   - Detects and resolves conflicts using "newest_wins" strategy
   - Stores complex conflicts for manual resolution

2. **Added convex_id_mapping table** (`services/db/sqlite.native.ts`)
   - Tracks relationship between local SQLite IDs and Convex IDs
   - Maintains entity type (series/sermon) for proper mapping

3. **Created Clerk sign-in modal** (`components/auth/ClerkSignInModal.tsx`)
   - Shows modal when user is not authenticated
   - Auto-triggers sync after successful login

4. **Updated all sync button handlers**
   - `components/sync/SyncStatusDashboard.tsx` - Unified auth check + sync
   - `app/(tabs)/sermons.tsx` - Sermons screen sync button
   - `components/series/SeriesListScreen.tsx` - Series screen sync button

5. **Updated auth session** (`services/authSession.ts`)
   - Added `syncClerkUserToLocal()` function
   - Links anonymous data to authenticated account after login

6. **Added Clerk auth listener** (`app/_layout.tsx`)
   - Listens for sign-in events
   - Automatically syncs Clerk user ID to local cache

7. **Updated Convex schema** (`convex/schema.ts`)
   - Added `localId` field to series and sermons tables
   - Added indexes for efficient lookup

## ⚠️ Next Steps Required

### 1. Run Convex Development Server

The Convex API types need to be generated. Run:

```bash
npx convex dev
```

This will:
- Generate TypeScript types in `convex/_generated/api.ts`
- Push schema changes to your Convex deployment
- Enable real-time subscriptions

### 2. Get Clerk Publishable Key

1. Go to https://clerk.com and create an account
2. Create a new application
3. Copy your publishable key from the API Keys section
4. Add to `.env.local`:

```bash
EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_your_actual_key_here
```

### 3. Configure Clerk Issuer URL

Update `convex/auth.config.ts` with your Clerk issuer URL from the Clerk dashboard.

### 4. Complete Clerk Sign-In Flow

The current `ClerkSignInModal` is a placeholder. You need to:
- Either navigate to the `/auth` screen when sign-in is needed
- Or integrate Clerk's native sign-in components directly in the modal

## How It Works

### Sync Flow

1. **User clicks sync button**
   - Check if user is authenticated with Clerk
   - If not, show Clerk sign-in modal
   - If authenticated, proceed to sync

2. **Push local changes to Convex**
   - Fetch all dirty records from SQLite (dirty = 1)
   - For each record:
     - Check if Convex ID mapping exists
     - If yes: Update in Convex
     - If no: Create in Convex and store mapping
   - Clear dirty flags after successful push

3. **Pull remote changes from Convex**
   - Fetch all records from Convex for current user
   - For each remote record:
     - Check if exists locally via Convex ID mapping
     - Detect conflicts by comparing field values
     - Apply "newest_wins" strategy for simple conflicts (≤2 fields)
     - Store complex conflicts for manual resolution
     - Update local SQLite if remote is newer

4. **Conflict Resolution**
   - Simple conflicts (≤2 fields changed): Automatic "newest_wins"
   - Complex conflicts (>2 fields): Stored for manual resolution UI
   - Timestamp comparison: `updatedAt` field determines winner

### ID Management

- Local IDs: UUIDs generated by React Native (e.g., `uuid-123`)
- Convex IDs: Generated by Convex (e.g., `Id<"series">`)
- Mapping stored in `convex_id_mapping` table: `local_id → convex_id + entity_type`

## Testing Checklist

Once Convex is running and Clerk is configured:

- [ ] Sync button shows Clerk login when not authenticated
- [ ] After login, sync automatically triggers
- [ ] Local changes push to Convex successfully
- [ ] Remote changes pull from Convex
- [ ] Timestamp-based conflicts resolve correctly
- [ ] Complex conflicts appear in resolution UI
- [ ] Sync works across all three button locations

## Known Limitations

1. **Convex API types**: Must run `npx convex dev` first (error is expected until then)
2. **Clerk sign-in modal**: Currently redirects to auth screen instead of inline sign-in
3. **Web sync**: Not yet implemented
4. **Real-time updates**: Convex subscriptions not yet implemented

## Architecture Decisions

1. **Conflict Resolution**: "newest_wins" with timestamp comparison (not merge)
2. **Sync Direction**: Push local first, then pull remote
3. **ID Mapping**: Separate table for tracking Convex-local relationships
4. **Auth Flow**: Modal approach that doesn't navigate away from current screen
5. **Error Handling**: Shows user-friendly alerts for auth and sync failures

